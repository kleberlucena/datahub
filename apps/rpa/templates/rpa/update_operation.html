{% extends "base/base.html" %}
{% load static %}

{% block style_sheet %}
<link rel="stylesheet" href="{% static 'adminlte-3.1.0/plugins/select2/css/select2.min.css' %}">
<link rel="stylesheet" href="{% static 'adminlte-3.1.0/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css' %}">
<link rel="stylesheet" href="{% static 'leaflet/leaflet.css' %}">
<style>
  .map_options {
    display: flex;
    gap: 10px;
  }

  /* Estilo para o ícone "x" */
  .input-container {
    position: relative;
    width: 400px;
  }

  .clear-icon {
    position: absolute;
    right: 10px;
    top: 10px;
    cursor: pointer;
  }

  /* fix select2 field height */
  .select2-selection,
  .select2-selection--single {
    height: 38px !important;
  }

  #select2-id_aeronave-container {
    height: 38px !important;
  }

  /* Menu collapse para pontos de interesse */
  .card_atendimento:hover {
    background-color: rgba(220, 220, 220, 1) !important;
    color: #FFF;
    font-weight: bold;
    cursor: pointer;
  }

  .card_atendimento:nth-child(even) {
    background-color: rgba(220, 220, 220, 0.3);
  }

  .loading_search {
    display: none;
  }

  @media (max-width: 768px) {
    .map_options {
      display: flex;
      flex-direction: column;
    }

    .input-container {
      position: relative;
      width: 100%;
    }
  }
</style>
{% endblock style_sheet %}

<!-- browser title -->
{% block title %} Editar Operação {% endblock %}

<!-- context title -->
{% block title-header %} Operações aéreas {% endblock %}

<!-- breadcrumb -->
{% block breadcrumb %}
  <li class="breadcrumb-item"><a href="{% url 'rpa:principal' %}">Operações</a></li>
  <li class="breadcrumb-item active">Editar operação</li>
{% endblock %}

<!-- main container -->
{% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="card card-primary card-outline">
      <div class="card-header">
        <h3 class="card-title">Editar operação</h3>
      </div>

      <form class="p-3" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-row">
          <div class="form-group col-md-12 mb-0">
            <div class="row mt-3">
              <div class="col-md-6">
                <label for="id_piloto_remoto" class="piloto_remoto">Piloto Remoto</label>
                <br>{{ user.military.rank }} {{ user.military.nickname }} - {{ user.military.register }}<br>
              </div>
            </div>
            <hr>
            <div class="row mt-3">
              <div class="col-md-6">
                <label for="id_title">Título da Operação</label>
                {{ form.title }}
                {{ form.title.errors }}
              </div>
              <div class="col-md-6">
                <label for="id_observer_pilot">Piloto Observador</label>
                <select id="select_observer_pilot" name="observer_pilot" class="form-control observer_pilot select2bs4">
                  <option value="">----</option>
                </select>
                {{ form.observer_pilot.errors }}
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-md-6">
                <label for="id_who_requested">Quem Solicitou</label>
                {{ form.who_requested }}
                {{ form.who_requested.errors }}
              </div>
              <div class="col-md-6">
                <label for="id_who_authorized">Quem Autorizou</label>
                {{ form.who_authorized }}
                {{ form.who_authorized.errors }}
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-md-6">
                <label for="id_aircraft">Aeronave</label>
                {{ form.aircraft }}
                {{ form.aircraft.errors }}
              </div>
              <div class="col-md-6">
                <label for="id_location" class="local">Local</label>
                {{ form.location }}
                {{ form.location.errors }}
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-md-6">
                <label for="id_latitude" class="local">Ponto de Decolagem: Latitude</label>
                {{ form.latitude }}
                {{ form.latitude.errors }}
              </div>
              <div class="col-md-6">
                <label for="id_longitude" class="local">Ponto de Decolagem: Longitude</label>
                {{ form.longitude }}
                {{ form.longitude.errors }}
              </div>
            </div>
            {{ form.user }}
          </div>
        </div>


        <div class="map_options">
          <button type="button" class="btn btn-outline-primary ml-3 mt-3" onclick="inserirPontoDecolagem();">Inserir
            Ponto de
            Decolagem</button>
          <div class="input-container mt-3">
            <input type="text" class="form-control" id="endereco" placeholder="Digite o endereço" />
            <i class="fas fa-times-circle clear-icon" onclick="limparCampo()"></i>
          </div>
          <button type="button" class="btn btn-outline-info mt-3" onclick="pesquisarEndereco()">Pesquisar
            Endereço</button>
          <div class="loading_search">
            <p style="margin-top: 25px;">Pesquisando...</p>
          </div>
        </div>

        <div id="map" class="ml-3 mr-3 mt-3" style="height: 400px;"></div>

        <div class="ml-3 mb-3 mt-3">
          <button type="submit" class="btn btn-primary">Salvar</button>
          <a href="{% url 'rpa:principal' %}">
            <button type="button" class="btn btn-warning">Cancelar</button>
          </a>
        </div>
      </form>
    </div>
  </div>
  {% endblock content %}

  <!-- javascripts -->
  {% block js %}
  <!-- DataTables  & Plugins -->
  <script src="{% static 'adminlte-3.1.0/plugins/select2/js/select2.min.js' %}"></script>
  <script src="{% static 'leaflet/leaflet.js' %}"></script>
  <script>
    // Inicializar o mapa
    let zoomLevel = 10;
    let map = L.map('map').setView([-7.015104, -35.402316], zoomLevel);
    var latitude = document.getElementById('id_latitude');
    var longitude = document.getElementById('id_longitude');
    var marcacao;
    let dadosMarcadores = {{ points_json | safe }}
    // Adicionar camada do mapa (pode ser substituído por outras camadas como OpenStreetMap, Mapbox, etc.)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Adicionar evento de clique no mapa
    map.on('click', function (e) {
      var lat = e.latlng.lat;
      var lng = e.latlng.lng;
      latitude.value = lat;
      longitude.value = lng;

      if (marcacao) {
        map.removeLayer(marcacao);
      }
      marcacao = L.marker([lat, lng]).addTo(map);
    });

    function inserirPontoDecolagem() {
      var lat = parseFloat(latitude.value);
      var lng = parseFloat(longitude.value);

      if (marcacao) {
        map.removeLayer(marcacao);
      }

      if (!isNaN(lat) && !isNaN(lng)) {

        marcacao = L.marker([lat, lng]).addTo(map);
        map.setView([lat, lng], 13);

      } else {
        alert('Coordenadas inválidas. Certifique-se de inserir valores numéricos válidos para latitude e longitude.');
      }
    }

    async function pesquisarEndereco() {
      var map_container = document.querySelector('.map_container');
      var enderecoInput = document.getElementById('endereco');
      var endereco = enderecoInput.value;
      let loading = document.querySelector('.loading_search');
      loading.classList.toggle('loading_search');

      try {
        const response = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(endereco));
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();

        if (data.length > 0) {
          loading.classList.toggle('loading_search');
          var lat = parseFloat(data[0].lat);
          var lng = parseFloat(data[0].lon);
          let zoom = 17;
          map.setView([lat, lng], zoom);
        } else {
          loading.classList.toggle('loading_search');
          alert('Endereço não encontrado. Certifique-se de digitar um endereço válido.');
        }
      } catch (error) {
        console.log('Erro ao pesquisar o endereço:', error);
      }
    }

    function limparCampo() {
      var enderecoInput = document.getElementById('endereco');
      enderecoInput.value = '';
    }

    const urlLocalImg = "{% static '/sti/img/attention.png' %}"
    const timedPoint = "{% static '/sti/img/timer.png' %}"
    var attentionIcon = L.icon({
      iconUrl: urlLocalImg,
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });
    var timerIcon = L.icon({
      iconUrl: timedPoint,
      iconSize: [35, 35],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    dadosMarcadores.forEach((dados) => {
      const lat = dados.latitude;
      const lng = dados.longitude;
      const descricao = dados.descricao;
      if (dados.temporary) {
        var marker = L.marker([lat, lng], { icon: timerIcon }).addTo(map);
        marker.bindPopup(descricao + '<br>' + `Evento: ${dados.date_initial} à ${dados.date_final}`);
      } else {
        var marker = L.marker([lat, lng], { icon: attentionIcon }).addTo(map);
        marker.bindPopup(descricao);
      }
    });

    const pontosAtendimento = document.querySelectorAll('.ponto-atendimento');

    pontosAtendimento.forEach(ponto => {
      ponto.addEventListener('click', function () {
        const lat = parseFloat(this.getAttribute('data-lat').replace(',', '.'));
        const lng = parseFloat(this.getAttribute('data-lng').replace(',', '.'));
        map.setView([lat, lng], 18);
      });
    });

  </script>


  <script>
    $(document).ready(function () {
      // Adicione um ID ao input do Select2 para o campo "Piloto observador"
      $('.observer_pilot_escolha').on('select2:open', function (e) {
        $('.select2-search__field').attr('id', 'select_observer_pilot_input');
      });
      $('#select_driver').on('select2:open', function (e) {
        $('.select2-search__field').attr('id', 'select_driver_input');
      });      
      $('.location').select2({theme: 'bootstrap4'});
      $('.observer_pilot').select2({
        ajax: {
          url: '{% url "portal:list_militaries" %}',
          dataType: 'json',
          delay: 250,
          processResults: function (data) {
            console.log(data)
            //updateObserverPilotSelect(data)
            return {
              results: data
            };
          },
          cache: true
        },
        minimumInputLength: 3,
        theme: 'bootstrap4'
      });
      $('.location_escolha').select2()
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var selectField = document.getElementById("id_user");
      selectField.readonly = true;
    });
  </script>

  <script>
    const pointOfInterestElements = document.querySelectorAll('.point_of_interest');

    pointOfInterestElements.forEach((point) => {
      point.addEventListener('click', function () {
        var targetElement = document.getElementById('map');
        targetElement.scrollIntoView({ behavior: 'smooth' });
      });
    });  
  </script>

  {% endblock %}