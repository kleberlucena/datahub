{% extends "base/base.html" %}
{% load static %}

<!-- styles -->
{% block style_sheet %}
  {% comment %} bacinf style_sheet {% endcomment %}
  <link rel="stylesheet" href="{% static 'adminlte-3.1.0/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'adminlte-3.1.0/plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'adminlte-3.1.0/plugins/datatables-buttons/css/buttons.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'adminlte-3.1.0/plugins/select2/css/select2.min.css' %}">
  <style>
      .novo_checklist {
        display: flex;
        justify-content: center;
    }
    
    .formulario_checklist_parte1 {
        display: flex;
        flex-direction: column;
        gap: 10px; 
        max-width: 100%;   
    }
    
    .formulario_checklist_selecao_itens, .formulario_checklist_parte2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 5px;
        max-width: 100%%;
    }
    
    .formulario_checklist_titulo_selecao {
        margin-top: 50px;
        margin-bottom: 50px;
    }
    
    .checklist_item {
        width: 30px;
        height: 30px;
    }
    
    .formulario_checklist_parte2 > input {
        margin-left: 100px;
    }
    
    .container_alteracoes_titulo {
        margin-top: 1rem;
    }
    
    #id_alteracoes {
        margin-top: 20px;
    }
    
    .edicao_checklist {
        display: none;
    }
    .formulario_checklist_alteracoes {
      max-width: 100%;
    }

    .formulario_checklist_parte2 > input {
      width: 1rem;
    }
    
    /* Correção da altura do campo selec2 */
    .select2-selection, .select2-selection--single{
      height: 38px !important;
    }

    #select2-id_aeronave-container {
      height: 38px !important;
    }

    #equipes-container {
      width: 100rem;
    }
  
    .card_content {
      display: grid;
      grid-template-columns: auto auto;
      gap: 30px;
    }
  
    .card_user_image {
      display: grid;
      grid-template-columns: auto auto;
      gap: 10px;
    }
    
    @media (max-width: 768px) {
    
        .formulario_checklist_selecao_itens {
            display: grid;
            grid-template-columns: 1fr;
            gap: 5px;
            max-width: 800px;
        }
    }
</style>
{% endblock style_sheet %}

<!-- browser title -->
{% block title %} Novo checklist {% endblock %}

<!-- context title -->
{% block title-header %} Operações aéreas {% endblock %}

<!-- breadcrumb -->
{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'rpa_manager:principal' %}">Principal</a></li>
<li class="breadcrumb-item active">Novo checklist</li>
{% endblock %}

<!-- main container -->
{% block content %}

<div class="row">
  <div class="col-md-12">
    <div class="card card-primary card-outline">
      <div class="card-header">
        <h3 class="card-title">Novo checklist</h3>
      </div>

      {% if guarnicao %}
        <div class="card-body">
          <div class="col-12 col-sm-6 col-md-4 d-flex align-items-stretch flex-column">
            <div class="card bg-light d-flex flex-fill">
              <div class="card-header text-muted border-bottom-0">
                <i class="fas fa-lg fa-building"></i> {{ guarnicao.local.cidades_pb }}
              </div>
              <div class="card-body pt-0">
                <div class="card_content">
                  <div class="card_gu_info">
                    <h2 class="lead"><i class="fa fa-car"></i> <b>Motorista:</b> {{ guarnicao.motorista }} </h2>
                    <h2 class="lead"><i class="fa fa-paper-plane"></i> <b>Piloto remoto:</b> {{ guarnicao.piloto_remoto }} </h2>
                    <h2 class="lead"><i class="fa fa-binoculars"></i> <b>Piloto observador:</b> {{ guarnicao.piloto_observador }}</h2>
                    <h2 class="lead"><i class="fa fa-phone"></i> <b>Contato:</b> {{ guarnicao.telefone }} <i class="fa fa-fw fa-whatsapp"></i></h2>
                  </div>
                  <div class="card_user_image">
                      <img src="{% static 'adminlte-3.1.0/img/user8-128x128.jpg' %}" alt="user-avatar" class="img-circle img-fluid">
                      <img src="{% static 'adminlte-3.1.0/img/user7-128x128.jpg' %}" alt="user-avatar" class="img-circle img-fluid">
                      <img src="{% static 'adminlte-3.1.0/img/user6-128x128.jpg' %}" alt="user-avatar" class="img-circle img-fluid">
                      <img src="{% static 'adminlte-3.1.0/img/user5-128x128.jpg' %}" alt="user-avatar" class="img-circle img-fluid">
                  </div>
              </div>
              <div class="card-footer">
                <div class="text-right">

                </div>
              </div>
            </div>
          </div>
          
          {% if request.user == guarnicao.piloto_remoto %}
            <a href="{% url 'rpa_manager:guarnicao_edit' guarnicao.pk %}">
              <button type="button" style="display: inline;" class="btn btn-block btn-primary mt-3 col-md-4"><i class="fa fa-pen"></i> Editar guarnição </button>
            </a>
          {% else %}
            <a href="{% url 'rpa_manager:guarnicao_edit' guarnicao.pk %}">
              <button type="button" style="display: inline; cursor: not-allowed;" class="btn btn-block btn-secondary mt-3 col-md-4"><i class="fa fa-pen"></i> Editar guarnição </button>
            </a>
          {% endif %}
            
        </div>
      {% endif %}

      <form  class="p-3" method='post' enctype="multipart/form-data">
        {% csrf_token %}
        <p class="edicao_checklist">{{ edicao_checklist }}</p> 

        <div class="container formulario_checklist_parte1">
          {{ checklist_form.piloto }}
          <label for="id_aeronave">Aeronave</label>
          Selecione uma aeronave para iniciar o checklist
          {{ checklist_form.aeronave }}
          <label for="id_num_helices">Número de hélices</label>
          {{ checklist_form.num_helices }}
          <label for="id_num_baterias">Número de baterias</label>
          {{ checklist_form.num_baterias }}
        </div>

        <h2 class="formulario_checklist_titulo_selecao">Marcar itens que estão Ok </h2>
        <div class="formulario_checklist_selecao_itens ">
          <div class="container formulario_checklist_parte2">
            <label for="id_baterias_carregadas">Baterias carregadas</label>
            {{ checklist_form.baterias_carregadas }}
            <label for="id_bateria_controle_carregada">Bateria controle carregada</label>
            {{ checklist_form.bateria_controle_carregada }}
            <label for="id_corpo">Corpo/Shell</label>
            {{ checklist_form.corpo }}
            <label for="id_hastes_motor">Hastes</label>
            {{ checklist_form.hastes_motor }}
            <label for="id_helices">Hélices</label>
            {{ checklist_form.helices }}
            <label for="id_gimbal">Gimbal</label>
            {{ checklist_form.gimbal }}
            <label for="id_holofote">Holofote</label>
            {{ checklist_form.holofote }}
            <label for="id_auto_falante">Auto-falante</label>
            {{ checklist_form.auto_falante }}
            <label for="id_luz_estroboscopica">Luz Estroboscópica</label>
            {{ checklist_form.luz_estroboscopica }}
            <label for="id_cabos">Cabos</label>
            {{ checklist_form.cabos }}
            <label for="id_carregador">Carregador</label>
            {{ checklist_form.carregador }}
          </div>

          <div class="p-3 formulario_checklist_parte2 ">
            <label for="id_fonte">Fonte de energia</label>
            {{ checklist_form.fonte }}
            <label for="id_smart_controller">Smart controller</label>
            {{ checklist_form.smart_controller }}
            <label for="id_controle">Controle remoto</label>
            {{ checklist_form.controle }}
            <label for="id_cartao_sd">Cartão SD</label>
            {{ checklist_form.cartao_sd }}
            <label for="id_IMU">IMU</label>
            {{ checklist_form.IMU }}
            <label for="id_compass">Compass/Bússola</label>
            {{ checklist_form.compass }}
            <label for="id_sinal_transmissao">Sinal de transmissão</label>
            {{ checklist_form.sinal_transmissao }}
            <label for="id_sistema_rtk_ppk">Sistema RTK PPK</label>
            {{ checklist_form.sistema_rtk_ppk }}
            <label for="id_paraquedas">Paraquedas</label>
            {{ checklist_form.paraquedas }}
            <label for="id_sinal_de_video">Sinal de vídeo</label>
            {{ checklist_form.sinal_de_video }}
            <label for="id_telemetria">Telemetria</label>
            {{ checklist_form.telemetria }}
          </div>
        </div>

        <div class="container formulario_checklist_alteracoes">
          <h4 class="formulario_checklist_titulo_selecao">Caso algum item não esteja ok, descrever abaixo as
            alterações:</h4>
          <label class="container_alteracoes_titulo" for="id_alteracoes">Alterações</label>
          <input type="button" class="btn btn-danger botao_limpar" value="Limpar" onclick="limpaAlteracoes();" /><br>
          {{ checklist_form.alteracoes }}
        </div>
        <div class="mt-3">
          {{ checklist_form.errors }}
          <button type="submit" class="btn btn-primary">Salvar</button>
          <a href="{% url 'rpa_manager:checklists' %}">
              <button type="button" class="btn btn-warning">Cancelar</button>
          </a>
        </div>
      </form>
    </div>
  </div>
{% endblock content %}

<!-- javascripts -->
{% block js %}
  <!-- DataTables  & Plugins -->
  <script src="{% static 'adminlte-3.1.0/plugins/datatables/jquery.dataTables.min.js' %}"></script>
  <script src="{% static 'adminlte-3.1.0/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
  <script src="{% static 'adminlte-3.1.0/plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
  <script src="{% static 'adminlte-3.1.0/plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
  <script src="{% static 'adminlte-3.1.0/plugins/datatables-buttons/js/dataTables.buttons.min.js' %}"></script>
  <script src="{% static 'adminlte-3.1.0/plugins/datatables-buttons/js/buttons.bootstrap4.min.js' %}"></script>
  <script src="{% static 'adminlte-3.1.0/plugins/jszip/jszip.min.js' %}"></script>
  <script src="{% static 'adminlte-3.1.0/plugins/pdfmake/pdfmake.min.js' %}"></script>
  <script src="{% static 'adminlte-3.1.0/plugins/pdfmake/vfs_fonts.js' %}"></script>
  <script src="{% static 'adminlte-3.1.0/plugins/datatables-buttons/js/buttons.html5.min.js' %}"></script>
  <script src="{% static 'adminlte-3.1.0/plugins/datatables-buttons/js/buttons.print.min.js' %}"></script>
  <script src="{% static 'adminlte-3.1.0/plugins/datatables-buttons/js/buttons.colVis.min.js' %}"></script>
  <script src="{% static 'adminlte-3.1.0/plugins/select2/js/select2.min.js' %}"></script>

  <script src="{% static 'controle/js/checklist_adiciona_alteracoes.js' %}"></script>


  <script>  
    $(document).ready(function() { 
      $('.aeronave_escolha').select2();

      $(".aeronave_escolha").on('change', function() {
        let aeronave_selecionada = $(this).val();
        let historico_checklist_dict_json = JSON.parse('{{ historico_checklist_dict_json|escapejs }}');
        
        function transformInBooleanValues(notTransformedJson) {
          let objeto = notTransformedJson;

          for (let chave in notTransformedJson) {
            if (objeto.hasOwnProperty(chave)) {
              let subObjeto = objeto[chave];
        
              for (let subChave in subObjeto) {
                if (subObjeto.hasOwnProperty(subChave)) {
                  let valor = subObjeto[subChave];
        
                  if (valor === 'False') {
                    subObjeto[subChave] = false;
                  } else if (valor === 'True') {
                    subObjeto[subChave] = true;
                  }
                }
              }
            }
          }
          return objeto;
        }

        let historico_checklist_json = transformInBooleanValues(historico_checklist_dict_json);
        let dadosAeronave = historico_checklist_json[aeronave_selecionada];
        
        if(dadosAeronave) {
          $('input[name="num_helices"]').val(dadosAeronave.num_helices);
          $('input[name="num_baterias"]').val(dadosAeronave.num_baterias); 
          $('input[name="baterias_carregadas"]').prop('checked', dadosAeronave.baterias_carregadas);
          $('input[name="bateria_controle_carregada"]').prop('checked', dadosAeronave.bateria_controle_carregada);
          $('input[name="corpo"]').prop('checked', dadosAeronave.corpo);
          $('input[name="hastes_motor"]').prop('checked', dadosAeronave.hastes_motor);
          $('input[name="helices"]').prop('checked', dadosAeronave.helices);
          $('input[name="gimbal"]').prop('checked', dadosAeronave.gimbal);
          $('input[name="holofote"]').prop('checked', dadosAeronave.holofote);
          $('input[name="auto_falante"]').prop('checked', dadosAeronave.auto_falante);
          $('input[name="luz_estroboscopica"]').prop('checked', dadosAeronave.luz_estroboscopica);
          $('input[name="cabos"]').prop('checked', dadosAeronave.cabos);
          $('input[name="carregador"]').prop('checked', dadosAeronave.carregador);
          $('input[name="fonte"]').prop('checked', dadosAeronave.fonte);
          $('input[name="smart_controller"]').prop('checked', dadosAeronave.smart_controller);
          $('input[name="controle"]').prop('checked', dadosAeronave.controle);
          $('input[name="cartao_sd"]').prop('checked', dadosAeronave.cartao_sd);
          $('input[name="IMU"]').prop('checked', dadosAeronave.IMU);
          $('input[name="compass"]').prop('checked', dadosAeronave.compass);
          $('input[name="sinal_transmissao"]').prop('checked', dadosAeronave.sinal_transmissao);
          $('input[name="sistema_rtk_ppk"]').prop('checked', dadosAeronave.sistema_rtk_ppk);
          $('input[name="sinal_de_video"]').prop('checked', dadosAeronave.sinal_de_video);
          $('input[name="telemetria"]').prop('checked', dadosAeronave.telemetria);
          $('input[name="paraquedas"]').prop('checked', dadosAeronave.paraquedas);
          $('textarea[name="alteracoes"]').val(dadosAeronave.alteracoes);
        }
        
        if (aeronave_selecionada === '1') {
            $('input[name="holofote"]').show();
            $('label[for="id_holofote"]').show();

            $('input[name="auto_falante"]').show();
            $('label[for="id_auto_falante"]').show();

            $('input[name="luz_estroboscopica"]').show();
            $('label[for="id_luz_estroboscopica"]').show();

            $('input[name="smart_controller"]').show();
            $('label[for="id_smart_controller"]').show();

            $('input[name="controle"]').hide();
            $('label[for="id_controle"]').hide();
        } else {
            $('input[name="holofote"]').hide();
            $('label[for="id_holofote"]').hide();

            $('input[name="auto_falante"]').hide();
            $('label[for="id_auto_falante"]').hide();

            $('input[name="luz_estroboscopica"]').hide();
            $('label[for="id_luz_estroboscopica"]').hide();

            $('input[name="smart_controller"]').hide();
            $('label[for="id_smart_controller"]').hide();

            $('input[name="controle"]').show();
            $('label[for="id_controle"]').show();
        }
      });
        
    });
  </script>
  

{% endblock %}